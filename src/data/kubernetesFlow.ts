import { Flow } from './types';

export const kubernetesFlow: Flow = {
  id: 'kubernetes',
  title: 'Kubernetes Pod Creation Flow',
  steps: [
    {
      id: 'k8s-1',
      stepNumber: 1,
      label: 'API Server receives Pod CREATE request',
      component: 'API Server',
      description: 'Client submits a Pod manifest via kubectl or the Kubernetes API. The API Server receives the request and begins processing.',
      isHookPoint: false,
      timing: '~1ms',
    },
    {
      id: 'k8s-2',
      stepNumber: 2,
      label: 'Authentication + Authorization',
      component: 'API Server',
      description: 'The API Server authenticates the caller (certificates, tokens) and checks RBAC policies to authorize the Pod creation.',
      isHookPoint: false,
      timing: '~2ms',
    },
    {
      id: 'k8s-3',
      stepNumber: 3,
      label: 'Mutating Admission Webhooks',
      component: 'Admission Controller',
      description: 'Mutating webhooks can modify the Pod spec. This is the earliest point where we know the Pod identity (name, namespace, labels) but NOT the target node.',
      isHookPoint: true,
      hookType: 'phase1',
      hookLabel: 'Phase 1: Pod Known, Node Unknown',
      infoAvailable: ['Pod name', 'Namespace', 'Labels', 'Annotations', 'Container images'],
      timing: '~5-50ms',
    },
    {
      id: 'k8s-4',
      stepNumber: 4,
      label: 'Validating Admission Webhooks',
      component: 'Admission Controller',
      description: 'Validating webhooks check the Pod spec against policies. They cannot modify the Pod, only accept or reject.',
      isHookPoint: false,
      timing: '~5-20ms',
    },
    {
      id: 'k8s-5',
      stepNumber: 5,
      label: 'Object persisted to etcd',
      component: 'etcd',
      description: 'The Pod object is written to etcd. At this point the Pod exists in the cluster but has no node assignment.',
      isHookPoint: false,
      timing: '~2-5ms',
    },
    {
      id: 'k8s-6',
      stepNumber: 6,
      label: 'kube-scheduler picks up Pod',
      component: 'Scheduler',
      description: 'The scheduler watches for unscheduled Pods. It detects the new Pod and begins the scheduling cycle.',
      isHookPoint: false,
      timing: '~10-50ms',
    },
    {
      id: 'k8s-7',
      stepNumber: 7,
      label: 'Filter + Score nodes',
      component: 'Scheduler',
      description: 'The scheduler filters out ineligible nodes, then scores remaining candidates based on resource availability, affinity rules, and other factors.',
      isHookPoint: false,
      timing: '~5-20ms',
    },
    {
      id: 'k8s-8',
      stepNumber: 8,
      label: 'Reserve Plugin',
      component: 'Scheduler',
      description: 'The Reserve plugin is called after the node is selected. Now we know BOTH the Pod identity AND the exact target node.',
      isHookPoint: true,
      hookType: 'phase2',
      hookLabel: 'Phase 2: Pod + Node Known',
      infoAvailable: ['Pod name', 'Namespace', 'Labels', 'Target node name', 'Node IP', 'Node resources'],
      timing: '~1ms',
    },
    {
      id: 'k8s-9',
      stepNumber: 9,
      label: 'Permit + PreBind + Bind',
      component: 'Scheduler',
      description: 'Final scheduling phases: Permit allows delayed approval, PreBind performs pre-binding operations, and Bind writes the node assignment to the API Server.',
      isHookPoint: false,
      timing: '~2-5ms',
    },
    {
      id: 'k8s-10',
      stepNumber: 10,
      label: 'Kubelet detects Pod, starts container',
      component: 'Kubelet',
      description: 'The Kubelet on the assigned node watches for Pods scheduled to it, pulls images, creates containers, and starts the workload.',
      isHookPoint: false,
      timing: '~500ms-10s',
    },
  ],
};

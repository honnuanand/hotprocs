import { Flow } from './types';

export const vrmFlow: Flow = {
  id: 'vrm',
  title: 'VRM: Voltage Regulator Module Flow',
  steps: [
    {
      id: 'vrm-1',
      stepNumber: 1,
      label: '12V Input Rail from PSU',
      component: 'Power Supply',
      description: 'The motherboard receives 12V DC from the PSU via the ATX 12V or EPS connector. This is the raw input to the VRM.',
      isHookPoint: false,
      timing: 'Continuous',
    },
    {
      id: 'vrm-2',
      stepNumber: 2,
      label: 'SVID: CPU requests target voltage',
      component: 'SVID Interface',
      description: 'The CPU communicates its desired voltage (VID) to the VRM controller via Serial Voltage Identification (SVID). Voltage requests change dynamically based on workload, P-states, and turbo boost.',
      isHookPoint: true,
      hookType: 'phase1',
      hookLabel: 'Phase 1: Target Voltage Known',
      infoAvailable: ['Requested Vcore', 'P-state', 'Turbo mode', 'Current limit'],
      timing: '~1 µs',
    },
    {
      id: 'vrm-3',
      stepNumber: 3,
      label: 'PWM Controller sets duty cycle',
      component: 'PWM Controller',
      description: 'The switching controller (e.g., ISL69269, RAA229131) receives the SVID command and computes the PWM duty cycle. D = Vout / Vin. For 0.75V out from 12V in, D ≈ 6.25%.',
      isHookPoint: false,
      timing: '~100 ns',
    },
    {
      id: 'vrm-4',
      stepNumber: 4,
      label: 'Error Amplifier (Diff Amp) compares FB',
      component: 'Error Amplifier',
      description: 'The differential amplifier compares the feedback voltage (from the output) with the reference voltage (from SVID). The error signal adjusts the PWM duty cycle to regulate Vout. Wait for nodal voltage going down — current is a factor of load.',
      isHookPoint: false,
      timing: 'Continuous',
    },
    {
      id: 'vrm-5',
      stepNumber: 5,
      label: 'Gate Driver amplifies PWM signal',
      component: 'Gate Driver',
      description: 'The gate driver takes the low-power PWM signal and amplifies it to drive the high-side and low-side MOSFETs. Critical for fast switching transitions (Vsw × Isw at transitions).',
      isHookPoint: false,
      timing: '~10-20 ns',
    },
    {
      id: 'vrm-6',
      stepNumber: 6,
      label: 'High-Side MOSFET switches ON',
      component: 'Power Stage',
      description: 'The high-side FET connects 12V input to the inductor. Current ramps up through the inductor (V = L × dI/dt). This is the "charging" phase of each switching cycle.',
      isHookPoint: false,
      timing: '~50-100 ns (switching)',
    },
    {
      id: 'vrm-7',
      stepNumber: 7,
      label: 'High-Side OFF, Low-Side MOSFET ON',
      component: 'Power Stage',
      description: 'The high-side FET turns off and low-side turns on (break-before-make). Inductor current freewheels through the low-side FET. Current ramps down. P_loss = I²×R (conduction losses in the FETs).',
      isHookPoint: false,
      timing: '~50-100 ns (switching)',
    },
    {
      id: 'vrm-8',
      stepNumber: 8,
      label: 'Inductor filters switching waveform',
      component: 'Inductor (L ≈ 100-300 nH)',
      description: 'The inductor smooths the pulsed square wave into near-DC current. Inductor ripple current determines output voltage ripple. Multiple phases interleave to reduce total ripple.',
      isHookPoint: false,
      timing: 'Per switching cycle (~1 µs at 1 MHz)',
    },
    {
      id: 'vrm-9',
      stepNumber: 9,
      label: 'Output capacitors smooth Vout',
      component: 'Output Capacitors',
      description: 'Banks of ceramic (MLCC) and polymer capacitors filter remaining ripple and provide transient energy storage. Critical for load transients — when the CPU suddenly demands hundreds of amps.',
      isHookPoint: false,
      timing: 'Continuous',
    },
    {
      id: 'vrm-10',
      stepNumber: 10,
      label: 'Vout delivered to CPU: 0.7–1.1V',
      component: 'CPU Load',
      description: 'The regulated output voltage (typically 0.7V–1.1V) is delivered to the processor die. TDC = 700W max, TDP = 1750W peak. At 0.75V and 1000A, P = V×I = 750W.',
      isHookPoint: true,
      hookType: 'phase2',
      hookLabel: 'Phase 2: Load Regulation Active',
      infoAvailable: ['Vout actual', 'Load current (I_DC)', 'Temperature', 'Power (V×I)', 'Efficiency'],
      timing: 'Continuous',
    },
    {
      id: 'vrm-11',
      stepNumber: 11,
      label: 'Feedback divider samples Vout',
      component: 'Feedback Network',
      description: 'A resistor divider at the output (FB node) scales Vout down to a level the error amplifier can compare against the reference. This closes the control loop.',
      isHookPoint: false,
      timing: 'Continuous',
    },
    {
      id: 'vrm-12',
      stepNumber: 12,
      label: 'Control loop adjusts — closed loop regulation',
      component: 'Closed Loop',
      description: 'The error amplifier output adjusts the PWM duty cycle continuously. If Vout drops (load increase), duty cycle increases. If Vout rises (load decrease), duty cycle decreases. The loop bandwidth determines transient response speed.',
      isHookPoint: false,
      timing: '~1-10 µs response',
    },
  ],
};

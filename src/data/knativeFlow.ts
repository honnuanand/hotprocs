import { Flow } from './types';

export const knativeFlow: Flow = {
  id: 'knative',
  title: 'Knative Scale-from-Zero Flow',
  steps: [
    {
      id: 'kn-1',
      stepNumber: 1,
      label: 'HTTP request arrives at Ingress Gateway',
      component: 'Ingress Gateway',
      description: 'An external HTTP request hits the cluster ingress (typically Istio or Kourier). The request carries the Host header identifying the Knative service.',
      isHookPoint: false,
      timing: '~1ms',
    },
    {
      id: 'kn-2',
      stepNumber: 2,
      label: 'Envoy ext_authz filter',
      component: 'Envoy',
      description: 'The ext_authz filter intercepts the request before routing. We can extract the Revision ID from the Host header — the earliest possible hook point.',
      isHookPoint: true,
      hookType: 'phase1',
      hookLabel: 'Earliest: Revision ID from Host Header',
      infoAvailable: ['Revision ID (from Host)', 'Request path', 'HTTP method'],
      timing: '~1-5ms',
    },
    {
      id: 'kn-3',
      stepNumber: 3,
      label: 'HealthHandler + ProbeHandler',
      component: 'Activator',
      description: 'Knative health and probe handlers process the request. Health checks are separated from application traffic.',
      isHookPoint: false,
      timing: '~1ms',
    },
    {
      id: 'kn-4',
      stepNumber: 4,
      label: 'ContextHandler: Revision identified',
      component: 'Activator',
      description: 'The ContextHandler resolves the full Revision object. Now we know the complete revision configuration, current replica count, and associated deployment.',
      isHookPoint: true,
      hookType: 'phase1',
      hookLabel: 'Revision Object + Replica Count Known',
      infoAvailable: ['Revision object', 'Replica count', 'Container config', 'Deployment name'],
      timing: '~2-5ms',
    },
    {
      id: 'kn-5',
      stepNumber: 5,
      label: 'MetricHandler + ConcurrencyReporter',
      component: 'Activator',
      description: 'Metrics are recorded for the incoming request. The ConcurrencyReporter tracks in-flight request counts for autoscaling decisions.',
      isHookPoint: false,
      timing: '~1ms',
    },
    {
      id: 'kn-6',
      stepNumber: 6,
      label: 'activationHandler: Throttler.Try()',
      component: 'Activator',
      description: 'The activation handler attempts to route the request. If no backends are available (scale-from-zero), the request is buffered while scaling occurs.',
      isHookPoint: false,
      timing: '~1ms (then waits)',
    },
    {
      id: 'kn-7',
      stepNumber: 7,
      label: 'ConcurrencyReporter sends stats via WebSocket',
      component: 'Activator',
      description: 'Concurrency statistics are sent to the Autoscaler via WebSocket connection. These stats drive scaling decisions.',
      isHookPoint: false,
      timing: '~1ms',
    },
    {
      id: 'kn-8',
      stepNumber: 8,
      label: 'Autoscaler runs scaling cycle',
      component: 'Autoscaler',
      description: 'The Autoscaler processes incoming metrics, applies the scaling algorithm (KPA or HPA), and determines the desired replica count.',
      isHookPoint: false,
      timing: '~100ms (tick interval)',
    },
    {
      id: 'kn-9',
      stepNumber: 9,
      label: 'KPA Reconciler: scale() patches 0 to N',
      component: 'KPA Reconciler',
      description: 'The KPA Reconciler patches the Deployment to scale from 0 to N replicas. This triggers Pod creation through the Kubernetes API.',
      isHookPoint: true,
      hookType: 'phase1',
      hookLabel: 'Late Phase 1: Deployment Identity Known',
      infoAvailable: ['Deployment name', 'Desired replicas', 'Pod template'],
      timing: '~5-10ms',
    },
    {
      id: 'kn-10',
      stepNumber: 10,
      label: 'K8s Scheduler: Reserve',
      component: 'Scheduler',
      description: 'The Kubernetes scheduler assigns the new Pod to a specific node. The Reserve plugin fires — now we know the exact node.',
      isHookPoint: true,
      hookType: 'phase2',
      hookLabel: 'Phase 2: Pod + Node Known',
      infoAvailable: ['Pod name', 'Target node', 'Node IP', 'All pod metadata'],
      timing: '~20-50ms',
    },
    {
      id: 'kn-11',
      stepNumber: 11,
      label: 'Kubelet starts pod, Activator probes',
      component: 'Kubelet + Activator',
      description: 'The Kubelet pulls images and starts the container. The Activator probes the new Pod until it reports healthy.',
      isHookPoint: false,
      timing: '~500ms-10s',
    },
    {
      id: 'kn-12',
      stepNumber: 12,
      label: 'Request forwarded to ready pod',
      component: 'Activator',
      description: 'Once the Pod is healthy, the buffered request is forwarded from the Activator to the ready Pod. The response flows back to the client.',
      isHookPoint: false,
      timing: '~1ms',
    },
  ],
};
